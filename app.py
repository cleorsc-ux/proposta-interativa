import streamlit as st
import os
import pandas as pd
from auth import autenticar
from pdf import gerar_pdf
from sheets import carregar_catalogo

# Autentica√ß√£o do usu√°rio
autenticar()  # Define st.session_state["nome"]

# Configura√ß√£o da p√°gina
st.set_page_config(page_title="Gerador de Propostas - √Årtico PRIME", layout="wide")

st.markdown("# üìÑ Gerador de Propostas - √Årtico PRIME")
st.markdown(f"Usu√°rio logado: **{st.session_state['nome']}**")

st.subheader("üî¢ Selecione os servi√ßos para esta proposta")

# Carrega o cat√°logo
catalogo = carregar_catalogo()
catalogo.columns = (
    catalogo.columns
    .str.strip()
    .str.lower()
    .str.normalize('NFKD')
    .str.encode('ascii', errors='ignore')
    .str.decode('utf-8')
)

# Garante que a coluna de valores seja num√©rica
if "valor_unitario" in catalogo.columns:
    catalogo["valor_unitario"] = pd.to_numeric(
        catalogo["valor_unitario"], errors="coerce"
    ).fillna(0.0)

servicos_selecionados = []
categorias = catalogo["categoria"].dropna().unique()

for cat in categorias:
    st.markdown(f"### üîπ {cat}")
    subset = catalogo[catalogo["categoria"] == cat]

    for _, row in subset.iterrows():
        with st.container(border=True):
            st.markdown(f"**{row['servico']}** ({row['unidade']})")
            col1, col2, col3 = st.columns([3, 2, 2])

            with col1:
                checked = st.checkbox("Incluir", key=f"check_{row['servico']}_{_}")

            with col2:
                # Garantir que o valor seja float v√°lido
                valor_raw = row.get("valor_unitario", 0)
                try:
                    valor_float = float(valor_raw)
                except (ValueError, TypeError):
                    try:
                        valor_float = float(str(valor_raw).replace(",", "."))
                    except Exception:
                        valor_float = 0.0

                valor_editado = st.number_input(
                    "Valor Unit√°rio (R$)",
                    min_value=0.0,
                    value=valor_float,
                    step=0.01,
                    format="%.2f",
                    key=f"valor_{row['servico']}_{_}"
                )

            with col3:
                qtd = st.number_input(
                    "Quantidade",
                    min_value=1,
                    value=1,
                    step=1,
                    key=f"qtd_{row['servico']}_{_}"
                )

            if checked:
                total = valor_editado * qtd
                servicos_selecionados.append({
                    "servico": row["servico"],
                    "unidade": row["unidade"],
                    "valor_unit": valor_editado,
                    "quantidade": qtd,
                    "total": total
                })

# RESUMO DOS SERVI√áOS SELECIONADOS
if servicos_selecionados:
    st.markdown("## üìä Resumo dos Servi√ßos Selecionados")
    df_resumo = pd.DataFrame(servicos_selecionados)
    df_resumo["valor_unit"] = df_resumo["valor_unit"].map(
        lambda x: f"R$ {x:,.2f}".replace(",", "X").replace(".", ",").replace("X", ".")
    )
    df_resumo["total"] = df_resumo["total"].map(
        lambda x: f"R$ {x:,.2f}".replace(",", "X").replace(".", ",").replace("X", ".")
    )

    st.dataframe(
        df_resumo[["servico", "unidade", "quantidade", "valor_unit", "total"]],
        use_container_width=True
    )

    total_geral = sum(
        float(str(x["total"]).replace("R$", "").replace(".", "").replace(",", "."))
        for x in df_resumo.to_dict(orient="records")
    )
    st.markdown(
        f"### üí∞ Total Geral: R$ {total_geral:,.2f}"
        .replace(",", "X").replace(".", ",").replace("X", ".")
    )

# DADOS DA PROPOSTA
st.subheader("üìÑ Dados da Proposta")
cliente = st.text_input("Nome do Cliente ou Projeto", placeholder="Ex: Condom√≠nio Ilhas Vivence")
prazo = st.text_input("Prazo de Execu√ß√£o", value="7 dias √∫teis")
garantias = st.text_input("Garantias", value="90 dias contra defeitos")
observacoes = st.text_area("Observa√ß√µes", value="Esta proposta est√° sujeita a altera√ß√µes conforme avalia√ß√£o t√©cnica da obra.")

# GERAR PDF
if st.button("üóìÔ∏è Gerar Proposta em PDF"):
    if not cliente:
        st.warning("Preencha o nome do cliente.")
    elif not servicos_selecionados:
        st.warning("Selecione ao menos um servi√ßo.")
    else:
        total = sum(item["total"] for item in servicos_selecionados)
        pdf_path = gerar_pdf(
            cliente=cliente,
            servicos=servicos_selecionados,
            total=total,
            extras={
                "prazo": prazo,
                "garantias": garantias,
                "obs": observacoes
            },
            usuario=st.session_state["nome"]
        )

        with open(pdf_path, "rb") as f:
            st.success("‚úÖ Proposta gerada com sucesso!")
            st.download_button(
                "‚¨áÔ∏è Baixar PDF",
                data=f,
                file_name=os.path.basename(pdf_path),
                mime="application/pdf"
            )
            st.info("Verifique o arquivo baixado ou envie para o cliente.")
